"use strict";var myList,txtPhone,txtLatitude,txtLongitude,txtAddress,txtId,txtFullName,txtShipmentTypeEnum,txtServiceId,txtShowingUiShipPrice,phoneNumberCleave,btnReloadShopingCartcartDetail,txtCode,txtDiscountcartDetail,txtDiscountCode,btnSubmitLoadDiscountCode,btnSearchWard,txtVnLocationName,txtVnLocationId,spanDataShipAddress,listLabelNeedPlaceId,btnComplete,btnShowSugestModel,btnLatLng,btnLoadLazyListVoucher,suggestLocationModel,vnLocationSuggestContainer,showListVoucherModel,userLocalStorage,isAuthenticated,vnLocatonNameContainer,storeLastVnLocationId,privateNoVnLocationMessage="",forceComplete=!0;function loadListVoucher(){btnLoadLazyListVoucher.click(),showListVoucherModel.removeAttribute("hidden"),showListVoucherModel.classList.add("visible"),document.querySelector("#frmLazyLoadDiscountCodeList [name='payTypeEnum']").value=document.querySelector("[name='OrderViewModel.PayTypeEnum']:checked").value,document.getElementById("btnSubmitLoadDiscountCodeList")?.click()}function loadVnLocationSuccess(){initVnLocationViewComponent("",function(e,t,o){txtVnLocationId.value=t,txtVnLocationName.value=o,updateRealAddress(),3==e&&updateVnLocation(!1)})}function initVoucher(e){var t=document.querySelector(e).querySelector("[data-generate-barcode]");t&&new QRCode(t,{text:t.dataset.generateBarcode,width:64,height:64,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.L})}function selecVoucher(e){txtDiscountCode.value=e,Site.RefreshUnobtrusiveValidate("#frmShipInfo"),uploadCart(e),loadVoucher(e),Site.ClosePopup()}async function processGetLatlongBtn(){if(btnLatLng&&navigator.geolocation)try{const e=await getCurrentPositionAsync(),{latitude:t,longitude:o}=e.coords;txtLatitude.value=t,txtLongitude.value=o;if(WNumbHelper.GetDistance(userLocalStorage.Latitude,userLocalStorage.Longitude,t,o)>.5&&(userLocalStorage.VnLocationId="",userLocalStorage.VnLocationName=""),userLocalStorage.Latitude=t,userLocalStorage.Longitude=o,LocalStorageHelper.Set(LocalStorageNamesEnum.UserConfigs,userLocalStorage),btnLatLng.classList.add("hide"),txtVnLocationId.value)return;const a=await getVnLocationByLatLngAsync(t,o);if(userLocalStorage.VnLocationId)return void selectedSuggestGeoLocation();renderSuggestLocationUI(a)}catch(e){1===e.code?alert("Bạn đã từ chối chia sẻ vị trí."):2===e.code&&btnLatLng.classList.add("hide")}else btnLatLng?.classList.add("hide")}function getCurrentPositionAsync(){return new Promise((e,t)=>{navigator.geolocation.getCurrentPosition(e,t)})}function getVnLocationByLatLngAsync(e,t){return new Promise((o,a)=>{AjaxRequest.SendRequestGetJson("POST","shopingcart/getvnlocationbyLatLng",{latitude:e,longitude:t},e=>{try{o(JSON.parse(e))}catch(e){a(e)}})})}function renderSuggestLocationUI(e){const t=Site.HtmlToElement("<li class='row padding-h padding-v-5 border-solid border-1 border-bottom'><label class='radio _cursor-pointer _vertical-align-middle'><input name='SuggestLocation' type='radio'/><i><span class='padding-left-5'>Tôi sẽ tự chọn phường xã</span></i></label></li>")[0];t.querySelector("input").addEventListener("change",()=>{resetUserLocation(),Site.ClosePopup()}),vnLocationSuggestContainer.appendChild(t),e?.forEach(e=>{const t=Site.HtmlToElement(`<li class='row padding-h padding-v-5 border-solid border-1 border-bottom'> <label class='radio _cursor-pointer _vertical-align-middle'> <input name='SuggestLocation' type='radio' data-lat='${e.geoLocation.coordinates.latitude}' data-lng='${e.geoLocation.coordinates.longitude}' data-full-address='${e.fullAddress}' data-level='${e.geoLocation.level}' data-vnlocation-id='${e.id}' /> <i><span class='padding-left-5'>${e.fullAddress}</span></i> </label> </li>`)[0];t.querySelector("input").addEventListener("change",e=>{userLocalStorage.VnLocationId=e.target.dataset.vnlocationId,userLocalStorage.VnLocationName=e.target.dataset.fullAddress,LocalStorageHelper.Set(LocalStorageNamesEnum.UserConfigs,userLocalStorage),Site.ClosePopup(),selectedSuggestGeoLocation()}),vnLocationSuggestContainer.appendChild(t)}),suggestLocationModel.removeAttribute("hidden"),suggestLocationModel.classList.add("visible")}function resetUserLocation(){txtLatitude.value="",txtLongitude.value="",userLocalStorage.VnLocationId="",userLocalStorage.VnLocationName="",userLocalStorage.Latitude=0,userLocalStorage.Longitude=0,LocalStorageHelper.Set(LocalStorageNamesEnum.UserConfigs,userLocalStorage)}function selectedSuggestGeoLocation(){var e=LocalStorageHelper.Get(LocalStorageNamesEnum.UserConfigs)??LocalStorageHelper.InitUserConfigs();txtVnLocationId.value=e.VnLocationId,txtVnLocationName.value=e.VnLocationName,document.querySelector("[data-warehouse-list-container] [name='SelectedWarehouseId']:checked")?selectWarehouse(e.Latitude,e.Longitude):updateVnLocation(),vnLocationSelectFormLazyLoadData(txtVnLocationId.value)}function showAnimation(){}function initPayment(){vnLocationSuggestContainer=document.querySelector("[geo-location-suggest]"),suggestLocationModel=document.getElementById("suggestLocationModel"),showListVoucherModel=document.getElementById("maskBlackListVoucherModel"),txtLatitude=document.getElementById("OrderViewModel_Latitude"),txtLongitude=document.getElementById("OrderViewModel_Longitude"),btnLatLng=document.getElementById("btnGetCurentLatLng"),(btnLoadLazyListVoucher=document.getElementById("btnShowMoreDiscountCode")).addEventListener("click",function(){Site.ClosePopup(),loadListVoucher()}),myList=document.getElementById("mylist"),txtPhone=document.getElementById("OrderViewModel_PhoneNumber"),txtShipmentTypeEnum=document.getElementById("OrderViewModel_ShipmentTypeEnum"),txtServiceId=document.getElementById("OrderViewModel_ServiceId"),txtShowingUiShipPrice=document.getElementById("OrderViewModel_NormalShipPrice"),(txtAddress=document.getElementById("OrderViewModel_Address")).onkeyup=Site.Debounce(function(){updateRealAddress()},300),txtId=document.getElementById("OrderViewModel_ShippingAddressId"),txtFullName=document.getElementById("OrderViewModel_FullName"),btnSearchWard=document.getElementById("btnSearchWard"),txtVnLocationName=document.getElementById("OrderViewModel_VnLocationName"),txtVnLocationId=document.getElementById("OrderViewModel_VnLocationId"),txtDiscountCode=document.getElementById("OrderViewModel_DiscountCode"),spanDataShipAddress=document.querySelector("[data-ship-address]"),txtDiscountCode.addEventListener("keyup",function(e){Site.Debounce(uploadCart(e.target.value),2e3)}),btnComplete=document.querySelector("#btnComplete"),listLabelNeedPlaceId=document.querySelectorAll("[data-check-paytype]"),btnShowSugestModel=document.getElementById("btnShowSugestModel")}function loadVoucher(e){e!=(txtCode=document.getElementById("txtCode")).value&&(txtCode.value=e,(btnSubmitLoadDiscountCode=document.getElementById("btnSubmitLoadDiscountCode")).click())}function uploadCart(e){console.log("uploadCart:"+e),loadVoucher(e),(txtDiscountcartDetail=document.getElementById("txtDiscountcartDetail")).value=e,(btnReloadShopingCartcartDetail=document.getElementById("btnReloadShopingCartcartDetail")).click()}function loadCleave(){var e=document.getElementById("OrderViewModel_PhoneNumber");phoneNumberCleave=new Cleave(e,{numericOnly:!0})}function loadAutoComplete(){new Awesomplete("#OrderViewModel_FullName",{filter:function(e,t){return Awesomplete.FILTER_CONTAINS(e,t.match(/[^\|]*$/)[0])},item:function(e,t){return Awesomplete.ITEM(e,t.match(/[^\|]*$/)[0])},replace:function(e){var t=this.input.value.match(/^.+\|\s*|/)[0];this.input.value=t+e.value.split("=")[1]}}),document.getElementById("OrderViewModel_FullName").addEventListener("awesomplete-selectcomplete",function(e){var t=e.text.value.split("=")[0];e.target.value=e.text.value.split("=")[1];for(var o=0;o<myList.options.length;o++){var a=myList.options[o];a.id===t&&(txtPhone.value=a.dataset.phone,txtAddress.value=a.dataset.address,txtId.value=t,console.log("autocomplet"),loadCleave())}}),document.getElementById("OrderViewModel_FullName").addEventListener("change",function(e){console.log("change"),loadCleave()})}function updateRealAddress(){spanDataShipAddress.innerHTML=txtAddress.value?(txtAddress.value+", "+txtVnLocationName.value).trim():txtVnLocationName.value}function loadLocationAutoComplete(){if(document.getElementById("suggestListLocationContainer"))$("#OrderViewModel_VnLocationName").autocomplete({appendTo:"#suggestListLocationContainer",serviceUrl:"/shopingcart/searchlocationcomplete?loadLatLng=True",deferRequestBy:300,minChars:3,noCache:!0,onSelect:function(e){updateRealAddress(e),txtVnLocationId.value=e.data.id,document.querySelector("[data-warehouse-list-container] [name='SelectedWarehouseId']:checked")?selectWarehouse(e.data.latitude,e.data.longitude):updateVnLocation()},triggerSelectOnValidInput:!1,showNoSuggestionNotice:!0,noSuggestionNotice:"Không tìm thấy địa chỉ",formatResult:function(e,t){return"<div class='padding-5  _cursor-poiter' data-lat='"+e.data.latitude+"' data-lng='"+e.data.longitude+"'  data level="+e.data.level+" data-vnlocation-id='"+e.data.id+"'>"+e.value+"</div>"},lookupFilter:function(e,t,o){return new RegExp("\\b"+$.Autocomplete.utils.escapeRegExChars(o),"gi").test(e.value)},onSearchStart:function(e){Site.AddClassElement(btnSearchWard,"active"),txtVnLocationId.value=""},onSearchComplete:function(e,t){Site.RemoveClassElement(btnSearchWard,"active")}});else{var e=document.querySelector("[select-place-model]");if(!e)return;e.classList.remove("hide"),txtVnLocationName.addEventListener("focusin",function(t){e.classList.remove("hide")}),document.addEventListener("click",function(t){t.composedPath().includes(vnLocatonNameContainer)||(e.classList.add("hide"),updateVnLocation(!1))},!1)}}function processListItemShopingCartcartDetail(){}function updateVnLocation(e=!1){var t=txtVnLocationId.value,o=document.querySelector("[data-warehouse-list-container] [name='SelectedWarehouseId']:checked");if(t!=storeLastVnLocationId||e)return console.log("Location change"),t!==userLocalStorage.VnLocationId?(txtLatitude.value="",txtLongitude.value=""):(txtLatitude.value=userLocalStorage.Latitude,txtLongitude.value=userLocalStorage.Longitude),storeLastVnLocationId=t,void submitLazyLoadDefaultDelivery(+document.querySelector("#frmShipInfo").dataset.money,o?o.value:"",txtAddress.value,txtVnLocationName.value,t,0,+document.querySelector("#frmShipInfo").dataset.weight,null,null,document.getElementById("OrderViewModel_DiscountCode").value)}function SelectShipmentTypeEnum(e){if(!e)return txtShipmentTypeEnum.value=null,txtServiceId.value="",void(txtShowingUiShipPrice.value="");var t=e.value,o=e.dataset.serviceId;console.log({selectedShipmentTypeEnum:t,selectedServiceId:o}),txtShipmentTypeEnum.value=t,txtServiceId.value=o,txtShowingUiShipPrice.value=e.dataset.price,userLocalStorage.selectedShipmentTypeEnum=t,userLocalStorage.serviceId=o,txtVnLocationId.value&&(userLocalStorage.VnLocationId=txtVnLocationId.value,userLocalStorage.VnLocationName=txtVnLocationName.value),LocalStorageHelper.Set(LocalStorageNamesEnum.UserConfigs,userLocalStorage);document.querySelector("#frmShipInfo");document.querySelector("#frmLazyLoadShopingCartcartDetail [name=ShipPriceFromUi]").value=e.dataset.price,document.querySelector("#frmLazyLoadShopingCartcartDetail [name=DiscountCode]").value=txtDiscountCode.value,document.querySelector("#frmLazyLoadShopingCartcartDetail [name=VnLocationId]").value=txtVnLocationId.value,document.querySelector("#frmLazyLoadShopingCartcartDetail [name=PayTypeEnum]").value=document.querySelector("[name='OrderViewModel.PayTypeEnum']:checked").value,console.log("click load cart"),(btnReloadShopingCartcartDetail=document.getElementById("btnReloadShopingCartcartDetail")).click();var a=document.querySelector("[data-more-paytype]");if(e.dataset.price){txtVnLocationName.classList.remove("text-warning");var n=document.getElementById("message");n&&(n.classList.add("text-info"),n.classList.remove("text-warning")),a.classList.add("hide");for(r=0;r<listLabelNeedPlaceId.length;r++){(i=listLabelNeedPlaceId[r]).classList.remove("disabled"),i.querySelector("input").removeAttribute("disabled")}}else{for(var r=0;r<listLabelNeedPlaceId.length;r++){var i;"Cod"===(i=listLabelNeedPlaceId[r]).dataset.checkPaytype?i.querySelector("input").dispatchEvent(new Site.CreateEvent("change")):(i.querySelector("input").disabled="disabled",i.classList.add("disabled"))}txtVnLocationName.classList.add("text-warning"),a.classList.remove("hide")}var d=document.querySelector("[data-user-rpoint]");if(d){var l=d.dataset.userRpoint;d.innerText=WNumbHelper.GetFrNumber(Math.min(discountShipPrice+sumdiscount,l))+" điểm R-Point"}}function LazyLoadShipmentTypeEnum(){var e=document.getElementById("shipPrice");e&&(e.innerText="Loadding...");var t=document.getElementById("suggestMessage");t&&(t.innerText="Loadding...")}function LazyLoadShipmentComplete(){const e=Array.from(document.querySelectorAll("._idListDelivery input[name=ShipmentTypeEnum]"));if(!e.length)return;let t=e.map(e=>({radio:e,disabled:e.disabled,shipmentTypeEnum:e.value,serviceId:e.dataset.serviceId,price:+e.dataset.price||0,virtualCost:+e.dataset.virtualCost||0})).filter(e=>!e.disabled&&e.shipmentTypeEnum&&e.price>0).map(e=>({...e,sortPrice:e.price-e.virtualCost}));if(!t.length)return void checkAndDispatch(e[0]);t.sort((e,t)=>e.sortPrice===t.sortPrice?t.shipmentTypeEnum-e.shipmentTypeEnum:e.sortPrice-t.sortPrice);const o=userLocalStorage.ShipmentTypeEnum??t[0].shipmentTypeEnum,a=userLocalStorage.ServiceId??t[0].serviceId;let n=t.find(e=>e.shipmentTypeEnum===o&&e.serviceId===a);n=n??t.find(e=>e.shipmentTypeEnum===o),n=n??(t.length>0?t[0]:null),n&&checkAndDispatch(n.radio)}function checkAndDispatch(e){e&&(e.checked=!0,e.dispatchEvent(new Site.CreateEvent("change")))}function changeButtonToNextStep(e){btnComplete.innerText=e}function checkLocationValid(e){if(!forceComplete&&!txtVnLocationId.value){var t=document.getElementById("modelMessage");t.innerHTML="Không xác định được: '"+txtVnLocationName.value+"'<br/>";var o=$("#OrderViewModel_VnLocationName").autocomplete().suggestions,a=document.getElementById("modelListLocation");if(a.innerHTML="",o.length){t.innerHTML+="Thay vì NHẬP hãy <strong>CHỌN</strong> đề xuất";for(var n=0;n<o.length;n++){var r=Site.HtmlToElement("<li class='padding _cursor-poiter hover-text-strong' data-location-id='"+o[n].data.id+"'>"+o[n].value+"</li>");r[0].addEventListener("click",function(e){txtVnLocationId.value=e.currentTarget.dataset.locationId,txtVnLocationName.value=e.currentTarget.innerText,updateVnLocation(),Site.ClosePopup()}),a.append(r[0])}}return btnShowSugestModel.click(),void e.abort()}userLocalStorage.OrderPhone=txtPhone.value,userLocalStorage.OrderAddress=txtAddress.value,userLocalStorage.OrderFulName=txtFullName.value,userLocalStorage.VnLocationId!==txtVnLocationId.value&&(userLocalStorage.Latitude=0,userLocalStorage.Longitude=0,userLocalStorage.VnLocationName="",userLocalStorage.VnLocationId=""),LocalStorageHelper.Set(LocalStorageNamesEnum.UserConfigs,userLocalStorage),Site.ShowMaskBlack(1e3,"maskBlackPayment")}function loadFromLocalUserStorange(){var e=LocalStorageHelper.Get(LocalStorageNamesEnum.UserConfigs)??LocalStorageHelper.InitUserConfigs();txtPhone.value=e?.OrderPhone??"",txtAddress.value=e?.OrderAddress??"",txtFullName.value=e?.OrderFulName??"",txtVnLocationName.value=e?.VnLocationName??"",txtVnLocationId.value=e?.VnLocationId??"",txtLatitude.value=userLocalStorage?.Latitude??0,txtLongitude.value=userLocalStorage?.Longitude??0,vnLocationSelectFormLazyLoadData(txtVnLocationId.value)}function warehouseSelected(){var e=document.querySelector("#OrderViewModel_SelectedWarehouseId"),t=document.querySelector("[data-warehouse-list-container] [name='SelectedWarehouseId']:checked");e.value=t?.value,updateVnLocation(!0)}function submitLazyLoadDefaultDelivery(e,t,o,a,n,r,i,d,l,c){document.querySelector("#frmLazyLoadDeliveryNormal")&&(null!=d&&(document.querySelector("#frmLazyLoadDeliveryNormal [name=ShipmentTypeEnum]").value=d),document.querySelector("#frmLazyLoadDeliveryNormal [name=TotalGoodsMoney]").value=e,document.querySelector("#frmLazyLoadDeliveryNormal [name=WarehouseId]").value=t,document.querySelector("#frmLazyLoadDeliveryNormal [name=DropAddress]").value=o,document.querySelector("#frmLazyLoadDeliveryNormal [name=DropVnLocation]").value=a,document.querySelector("#frmLazyLoadDeliveryNormal [name=VnDropLocationId]").value=n,document.querySelector("#frmLazyLoadDeliveryNormal [name=Volumn]").value=r,document.querySelector("#frmLazyLoadDeliveryNormal [name=Weight]").value=i,document.querySelector("#frmLazyLoadDeliveryNormal [name=DiscountCode]").value=c,document.getElementById("btnLazyLoadDeliveryNormalSelector").click())}document.addEventListener("DOMContentLoaded",async function(){userLocalStorage=LocalStorageHelper.Get(LocalStorageNamesEnum.UserConfigs)??LocalStorageHelper.InitUserConfigs(),initPayment(),loadCleave(),loadAutoComplete(),loadLocationAutoComplete(),updateRealAddress(),vnLocatonNameContainer=document.querySelector("[data-vn-location]"),(isAuthenticated="True"==!!document.querySelector("[data-authenticated]").dataset.authenticated)||loadFromLocalUserStorange(),document.getElementById("btnSubmitLoadDiscountCode").click(),await processGetLatlongBtn(),console.log("Xong rồi nè"),updateVnLocation(!0)});