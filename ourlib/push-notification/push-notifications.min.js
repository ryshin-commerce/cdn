var PushNotifications=function(){let t;function e(t){for(var i="",e=new Uint8Array(t),o=e.byteLength,n=0;n<o;n++)i+=String.fromCharCode(e[n]);return window.btoa(i)}function o(t){PushNotifications.PushServiceWorkerRegistration&&PushNotifications.PushServiceWorkerRegistration.pushManager.getSubscription().then(function(i){for(var e=document.querySelectorAll(t+" [data-subscribe-container]"),o=0;o<e.length;o++)for(var s=e[o].querySelectorAll("[data-subscribe]"),r=0;r<s.length;r++)n(e[o],s[r],"denied"===Notification.permission,i)})}function n(t,i,n,r){if(null===r&&console.log("subscription is null"),i){var u=null!==r;n?(i.disabled=!0,i.innerText="Thông báo bị chặn",i.classList.add("disabled"),i.removeAttribute("data-subscribe"),i.outerHTML=i.outerHTML):u?(i.classList.add("_isSubscibed"),i.hasAttribute("data-subscribe-import-product")&&s(i,r),i.hasAttribute("data-subscribe-flash-sale")&&function(t,i){if(!t)return;i.p256dh=e(i.getKey("p256dh")),i.auth=e(i.getKey("auth")),fetch("/checkSubcribeLikeProduct?productId="+t.dataset.subscribeProductId,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(function(e){e.ok&&200===e.status?(t.classList.add("_isSubscibedFlashSale"),console.log("Successfully subscribed from Push Notifications"),t.innerHTML='<i class="fa fa-heart text-red" aria-hidden="true"></i>',t.removeAttribute("data-subscribe-flash-sale"),t.outerHTML=t.outerHTML):t.addEventListener("click",function(e){c(t,i)})}).catch(function(t){})}(i,r)):i.addEventListener("click",function(t,e){PushNotifications.subscribeForPushNotifications(function(t){PushNotifications.PushServiceWorkerRegistration.pushManager.getSubscription().then(function(t){t&&(i.hasAttribute("data-subscribe-import-product")&&(i.setAttribute("data-ignore-check-subscribe","true"),c(i,t)),i.hasAttribute("data-subscribe-flash-sale")&&(i.setAttribute("data-ignore-check-subscribe","true"),c(i,t)),o("body"))})})}),n&&console.log("Permission for Push Notifications has been denied")}}function s(t,o){t&&(t.hasAttribute("data-ignore-check-subscribe")||(o.p256dh=e(o.getKey("p256dh")),o.auth=e(o.getKey("auth")),fetch("/checkSubcribeInportProduct?productId="+t.dataset.subscribeProductId,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then(function(e){e.ok&&200===e.status?(t.classList.add("_isSubscibedImport"),console.log("Successfully subscribed from Push Notifications"),t.innerText="Thông báo khi có hàng",t.removeAttribute("data-subscribe-import-product"),t.outerHTML=t[i].outerHTML):t.addEventListener("click",function(i){c(t,o)})}).catch(function(t){})))}function r(t){void 0===PushNotifications.PushServiceWorkerRegistration&&navigator.serviceWorker.getRegistration().then(function(i){void 0===i?navigator.serviceWorker.register("/push-service-worker.js",{scope:"/"}).then(function(i){PushNotifications.PushServiceWorkerRegistration=i,PushNotifications.Subscription=i.pushManager.getSubscription(),t()}).catch(function(t){console.log("Push Service Worker registration has failed: "+t)}):(PushNotifications.PushServiceWorkerRegistration=i,PushNotifications.Subscription=i.pushManager.getSubscription(),t())}).catch(function(t){console.log("Push Service Worker registration has failed: "+t)})}function c(t,i){i.p256dh=e(i.getKey("p256dh")),i.auth=e(i.getKey("auth")),t.hasAttribute("data-subscribe-flash-sale")?fetch("/likeproduct?productId="+t.dataset.subscribeProductId,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(function(i){i.ok?(Site.NotifyFormSuccess("THÔNG BÁO","Chúng tôi sẽ thông báo khi có trương trình khuyến mãi cho sản phẩm này."),t.classList.add("_isSubscibedFlashSale"),console.log("Successfully subscribed from Push Notifications"),t.innerHTML='<i class="fa fa-heart text-red" aria-hidden="true"></i>',t.removeAttribute("data-subscribe-flash-sale"),new Function(t.dataset.subcribeCallback)(),t.outerHTML=t.outerHTML):(console.log("Failed to discard the Push Notifications subscrition from server"),Site.NotifyFormFailed("Thông báo","Bạn đã tắt chức năng thông báo trên trình duyệt, vui lòng kích hoặt lại"))}).catch(function(t){console.log("Failed to discard the Push Notifications subscrition from server: "+t)}):t.hasAttribute("data-subscribe-import-product")&&fetch("/subcribeproduct?productId="+t.dataset.subscribeProductId,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(function(i){i.ok?(t.classList.add("_isSubscibedImport"),console.log("Successfully subscribed from Push Notifications"),t.innerText="Thông báo khi có hàng",t.removeAttribute("data-subscribe-import-product"),new Function(t.dataset.subcribeCallback)(),t.outerHTML=t.outerHTML):(console.log("Failed to discard the Push Notifications subscrition from server"),Site.NotifyFormFailed("Thông báo","Bạn đã tắt chức năng thông báo trên trình duyệt, vui lòng kích hoặt lại"))}).catch(function(t){console.log("Failed to discard the Push Notifications subscrition from server: "+t)})}function u(i){PushNotifications.PushServiceWorkerRegistration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t}).then(function(t){t.p256dh=e(t.getKey("p256dh")),t.auth=e(t.getKey("auth")),fetch("/subscriptions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(function(t){t.ok?(Site.NotifyFormSuccess("THÔNG BÁO","Nhận thông báo thành công."),i()):Site.NotifyFormFailed("THÔNG BÁO","Nhận thông báo thất bại")}).catch(function(t){console.log("Failed to store the Push Notifications subscrition on server: "+t),Site.NotifyFormFailed("LỖI","Không thể nhận thông báo từ server. Có lỗi bất thường xảy ra.")})}).catch(function(t){"denied"===Notification.permission?Site.NotifyFormFailed("THÔNG BÁO","Trình duyệt của bạn đang chặn thông báo vui lòng kích hoặt lại."):(console.log("Failed to subscribe for Push Notifications: "+t),Site.NotifyFormFailed("LỖI","Không thể nhận thông báo từ trình duyệt này."))})}return{initialize:function(t){if(!1 in navigator)console.log("Service Workers are not supported");else if(!1 in window)console.log("Push API not supported");else if(t)r(t);else{r(function(){o("body")})}},subscribeForPushNotifications:function(i){if(!t)return fetch("/public-key").then(function(t){if(t.ok)return t.text();console.log("Failed to retrieve Public Key")}).then(function(e){t=function(t){const i=(t+"=".repeat((4-t.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),e=window.atob(i),o=new Uint8Array(e.length);for(let t=0;t<e.length;++t)o[t]=e.charCodeAt(t);return o}(e),console.log("Successfully retrieved Public Key"),u(i)}).catch(function(t){console.log("Failed to retrieve Public Key: "+t)});u(i)},bindingUi:function(t){o(t)},checkSubcribeImport:function(t){s(t)},unsubscribeFromPushNotifications:function(){PushNotifications.PushServiceWorkerRegistration.pushManager.getSubscription().then(function(t){t&&t.unsubscribe().then(function(){fetch("/subscriptions?endpoint="+encodeURIComponent(t.endpoint),{method:"DELETE"}).then(function(t){t.ok?console.log("Successfully unsubscribed from Push Notifications"):console.log("Failed to discard the Push Notifications subscrition from server")}).catch(function(t){console.log("Failed to discard the Push Notifications subscrition from server: "+t)})}).catch(function(t){console.log("Failed to unsubscribe from Push Notifications: "+t)})})}}}();document.addEventListener("DOMContentLoaded",function(){});